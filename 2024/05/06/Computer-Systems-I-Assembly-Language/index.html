<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Penner"><meta name="keywords" content=""><meta name="description" content="RISC-V Assembly Language"><meta property="og:type" content="article"><meta property="og:title" content="Computer Systems I-汇编语言"><meta property="og:url" content="http://example.com/2024/05/06/Computer-Systems-I-Assembly-Language/index.html"><meta property="og:site_name" content="Penner的小屋"><meta property="og:description" content="RISC-V Assembly Language"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://s2.loli.net/2024/05/06/sP7G6AerKzIxnqC.png"><meta property="og:image" content="https://s2.loli.net/2024/05/06/YVMtDgzCiGaJSr2.png"><meta property="article:published_time" content="2024-05-06T08:47:21.000Z"><meta property="article:modified_time" content="2024-05-06T11:39:40.238Z"><meta property="article:author" content="Penner"><meta property="article:tag" content="笔记"><meta property="article:tag" content="计统"><meta property="article:tag" content="汇编"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://s2.loli.net/2024/05/06/sP7G6AerKzIxnqC.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>Computer Systems I-汇编语言 - Penner的小屋</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.5",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 7.2.0"></head><body><header><div class="header-inner" style="height:80vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Penner的小屋</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/Distorted%20Fate.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Computer Systems I-汇编语言"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-05-06 16:47" pubdate>2024年5月6日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4.1k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 35 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">Computer Systems I-汇编语言</h1><div class="markdown-body"><p>RISC-V Assembly Language</p><span id="more"></span><h2 id="some-basic-concepts"><a class="markdownIt-Anchor" href="#some-basic-concepts"></a> Some basic concepts</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> y;<br>    y = sum(<span class="hljs-number">42</span>,<span class="hljs-number">7</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span>&#123;<br>    <span class="hljs-keyword">return</span> (a + b);<br>&#125;<br></code></pre></td></tr></table></figure><p>Caller: calling function</p><ul><li>main in this case</li><li>Passes arguments to callee</li><li>Jumps to callee</li></ul><p>Callee: called function</p><ul><li>sum in this case</li><li>Performs the function</li><li>Returns result to caller</li><li>Returns to point of call</li></ul><h3 id="calling-convention"><a class="markdownIt-Anchor" href="#calling-convention"></a> Calling Convention</h3><p>Six general stages in calling a function</p><ol><li>Place the arguments where the function can access them.</li><li>Jump to the function (using RV32I’s jal).</li><li>Acquire local storage resources the function needs, saving registers as required.</li><li>Perform the desired task of the function.</li><li>Place the function result value where the calling program can access it, restore any registers, and release any local storage resources.</li><li>Since a function can be called from several points in a program, return control to the point of origin (using ret).</li></ol><h3 id="function-entry-and-exit"><a class="markdownIt-Anchor" href="#function-entry-and-exit"></a> Function Entry and Exit</h3><h4 id="the-function-prologue"><a class="markdownIt-Anchor" href="#the-function-prologue"></a> The function prologue</h4><p>If there are too many function arguments and variables to fit in the registers, the prologue allocates space on the stack for the function frame, as it is called.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">entry_label:<br>	addi sp,sp,-framesize  #Allocate space for stack frame <br>						   #by adjusting stack pointer (sp register)<br>	sw ra,framesize-4(sp) #Save return address (ra register)<br>	#save other registers to stack if needed<br></code></pre></td></tr></table></figure><h4 id="the-function-epilogue"><a class="markdownIt-Anchor" href="#the-function-epilogue"></a> The function epilogue</h4><p>Undoes the stack frame and returns to the point of origin</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#restore registers from stack if needed<br>lw ra,framesize-4(sp)  #Restore return address register<br>addi sp,sp, framesize  #De-allocate space for stack frame<br>ret                    #Return to calling point<br></code></pre></td></tr></table></figure><h2 id="from-source-code-to-a-running-program"><a class="markdownIt-Anchor" href="#from-source-code-to-a-running-program"></a> From source code to a running program</h2><ol><li>Write source code</li><li>Turn the source code into the executable program</li><li>Run it!</li></ol><p>Step of translation from C source code to a running program. These are the logical steps, although some steps are combined to accelerate translation.</p><h3 id="compiler-c-s"><a class="markdownIt-Anchor" href="#compiler-c-s"></a> Compiler: *.c-&gt;*.s</h3><h4 id="preprocessorc-i"><a class="markdownIt-Anchor" href="#preprocessorc-i"></a> Preprocessor(*.c-&gt;*.i)</h4><p>Expands all macro definitions and include statements (and anything else starting with a #) and passes the result to the actual compiler.</p><h4 id="compileri-s"><a class="markdownIt-Anchor" href="#compileri-s"></a> Compiler(*.i-&gt;*.s)</h4><p><img src="https://s2.loli.net/2024/05/06/sP7G6AerKzIxnqC.png" srcset="/img/loading.gif" lazyload alt="image-20240506172816202"></p><h3 id="assembler-s-o"><a class="markdownIt-Anchor" href="#assembler-s-o"></a> Assembler: *.s-&gt;*.o</h3><p>Not simply to produce object code from the instructions that the processor understands. But to extend then to include operations useful for the assembly language programmer or the compiler writer.</p><table><thead><tr><th>Pseudo instruction</th><th>Base Instruction(s)</th><th>Meaning</th></tr></thead><tbody><tr><td>nop</td><td>addi x0, x0, 0</td><td>No operation</td></tr><tr><td>neg re, rs</td><td>sub rd, x0, rs</td><td>Two’s complement</td></tr><tr><td>ret</td><td>jalr x0, x1, 0</td><td>Return from subroutine</td></tr></tbody></table><h3 id="output-in-risc-v-machine-language-o"><a class="markdownIt-Anchor" href="#output-in-risc-v-machine-language-o"></a> Output: in RISC-V Machine Language (*.o)</h3><p>The assembler produces the object using the **Executable and Linkable Format **(ELF, formerly named <strong>Extensible Linking Format</strong>) standard format.</p><p><img src="https://s2.loli.net/2024/05/06/YVMtDgzCiGaJSr2.png" srcset="/img/loading.gif" lazyload alt="image-20240506173937940"></p><p>Executable and Linkable Format (ELF) is a common standard file format for executable files, object code, shared libraries, and core dumps.</p><p>The standard binary file format for Unix and Unix-like systems on x86 processors by the 86open project.</p><p>By design, the ELF format is flexible, extensible, and cross-platform. This has allowed it to be adopted by many different operating systems on many different hardware platforms.</p><h3 id="linker-multiple-o-aout"><a class="markdownIt-Anchor" href="#linker-multiple-o-aout"></a> Linker: (multiple) (*.o-&gt;a.out)</h3><p>Rather than compile all the source code every time one file changes, the linker allows individual files to be compiled and assembled separately.<br>Why separate compile/assemble and linking steps?<br>Separately compiling modules and linking them together avoids the need to recompile the whole program every time something changes. Need to just recompile a small module. A linker coalesces object files together to create a complete program.</p><h4 id="linker-functions-1-fixing-addresses"><a class="markdownIt-Anchor" href="#linker-functions-1-fixing-addresses"></a> Linker Functions 1: Fixing Addresses</h4><p>Addresses in an object file are usually relative to the start of the code or data segment in that file.</p><p>When different object files are combined, the same kind of segments from the different object files get merged. Addresses have to be “fixed up” to account for this merging. The fixing up is done by the linker, using information embedded in the executable for this purpose</p><h4 id="linker-functions-2-symbol-resolution"><a class="markdownIt-Anchor" href="#linker-functions-2-symbol-resolution"></a> Linker Functions 2: Symbol Resolution</h4><p>Suppose: Module B defines a symbol x; Module A refers to x.</p><p>The linker must determine the location of x in the object module obtained from merging A and B and modify references to x to refer to this location.</p><p>Each linkable module contains a symbol table,whose contents include:</p><ul><li>Global symbols defined in the module.</li><li>Global symbols referenced but not defined in the module (externals).</li><li>Segment names (e.g., text,data, rodata).</li><li>These are usually considered to be global symbols defined to be at the beginning of the segment.</li><li>Non-global symbols and line number information, for debuggers.</li></ul><h3 id="format-of-the-executable-object-file"><a class="markdownIt-Anchor" href="#format-of-the-executable-object-file"></a> Format of the (Executable) Object File</h3><ul><li>Header<ul><li>Location of main entry point</li></ul></li><li>Text Segment<ul><li>Instructions</li></ul></li><li>Data Segment<ul><li>Static data (local/global vars, strings, constants)</li></ul></li><li>Relocation Information<ul><li>Instructions and data that depend on actual addresses</li><li>Linker patches these bits after relocating segments</li></ul></li><li>Symbol Table<ul><li>Exported and imported references</li></ul></li><li>Debugging Information</li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0/" class="category-chain-item">课堂笔记</a> <span>></span> <a href="/categories/%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9FI/" class="category-chain-item">计算机系统I</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E7%AC%94%E8%AE%B0/" class="print-no-link">#笔记</a> <a href="/tags/%E8%AE%A1%E7%BB%9F/" class="print-no-link">#计统</a> <a href="/tags/%E6%B1%87%E7%BC%96/" class="print-no-link">#汇编</a></div></div><div class="license-box my-3"><div class="license-title"><div>Computer Systems I-汇编语言</div><div>http://example.com/2024/05/06/Computer-Systems-I-Assembly-Language/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Penner</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2024年5月6日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/2024/05/06/Calculus-A-II-Computation-of-Double-Integral/" title="微甲II-二重积分的计算"><span class="hidden-mobile">微甲II-二重积分的计算</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="twikoo"></div><script type="text/javascript">Fluid.utils.loadComments("#comments",(function(){Fluid.utils.createScript("https://gcore.jsdelivr.net/npm/twikoo@1.6.32/dist/twikoo.all.min.js",(function(){var t=Object.assign({envId:"https://twikoo-hazel-pi.vercel.app",region:"ap-shanghai",path:"window.location.pathname",js:"https://gcore.jsdelivr.net/npm/twikoo@1.6.32/dist/twikoo.all.min.js"},{el:"#twikoo",path:"window.location.pathname",onCommentLoaded:function(){Fluid.utils.listenDOMLoaded((function(){var t="#twikoo .tk-content img:not(.tk-owo-emotion)";Fluid.plugins.imageCaption(t),Fluid.plugins.fancyBox(t)}))}});twikoo.init(t)}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>